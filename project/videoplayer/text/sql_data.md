# ***一、数据库表的设计***

## **`1.身份表`**

| 字段   | 类型          | 约束 | 空值       | 备注             |
| :--- | :---------- | :- | :------- | :------------- |
| ID   | INT         | PK | NOT NULL |                |
| 身份ID | VARCHAR(64) | UK | NOT NULL |                |
| 身份类型 | TINYINT     | UK | NOT NULL | 0-未知、1-C端、2-B端 |
| 身份备注 | VARCHAR(64) |    | NOT NULL |                |

## **2.角色表**

| 字段 | 类型  | 约束 | 空值       | 备注 |
| :- | :-- | :- | :------- | :- |
| ID | INT | PK | NOT NULL |    |
|    |     |    | NOT NULL |    |
|    |     |    | NOT NULL |    |

## **3.操作表**

| 字段   | 类型           | 约束 | 空值       | 备注  |
| :--- | :----------- | :- | :------- | :-- |
| ID   | INT          | PK | NOT NULL |     |
| 操作ID | VARCHAR(64)  | UK | NOT NULL |     |
| 操作   | VARCHAR(255) | NK | NOT NULL | URL |
| 操作备注 | VARCHAR(64)  |    | NOT NULL |     |

## **4.用户表**

| 字段     | 类型              | 约束 | 空值       | 备注       |
| :----- | :-------------- | :- | :------- | :------- |
| ID     | BIGINT UNSIGNED | PK | NOT NULL |          |
| 用户ID   | VARCHAR(64)     | UK | NOT NULL |          |
| 注册手机号  | VARCHAR(32)     |    | NULL     |          |
| 昵称     | VARCHAR(32)     | UK | NULL     |          |
| 用户昵称   | VARCHAR(64)     | UK | NULL     | 用于显示昵称   |
| 备用邮箱   | VARCHAR(64)     |    | NULL     | 用于账号恢复   |
| 密码     | VARCHAR(32)     |    | NULL     |          |
| 头像文件ID | VARCHAR(64)     |    | NULL     | 用于头像显示   |
| 用户备注   | TEXT            |    | NULL     |          |
| 用户状态   | TINYINT         |    | NOT NULL | 0-禁用1-启用 |
| 注册时间   | DATETIME        |    | NOT NULL |          |

## **5.会话表**

| 字段   | 类型              | 约束 | 空值       | 备注        |
| :--- | :-------------- | :- | :------- | :-------- |
| ID   | BIGINT UNSIGNED | PK | NOT NULL |           |
| 会话ID | VARCHAR(64)     | UK | NOT NULL |           |
| 用户ID | VARCHAR(64)     | UK | NULL     | 为空则表示其他账号 |

## **6.用户身份关系表**

| 字段   | 类型              | 约束 | 空值       | 备注 |
| :--- | :-------------- | :- | :------- | :- |
| ID   | BIGINT UNSIGNED | PK | NOT NULL |    |
| 用户ID | VARCHAR(64)     | FK | NOT NULL |    |
| 身份类型 | TINYINT         | FK | NOT NULL |    |
| 角色类型 | TINYINT         | FK | NOT NULL |    |

## **7.授权角色关系表**

| 字段   | 类型           | 约束 | 空值       | 备注  |
| :--- | :----------- | :- | :------- | :-- |
| ID   | INT          | PK | NOT NULL |     |
| 权限操作 | VARCHAR(255) | NK | NOT NULL | URL |
| 角色类型 | TINYINT      | FK | NOT NULL |     |

## **8.用户关注表**

| 字段     | 类型              | 约束 | 备注         |
| :----- | :-------------- | :- | :--------- |
| ID     | BIGINT UNSIGNED | PK |            |
| 粉丝用户ID | VARCHAR(64)     | NK | 自己关注的主播放列表 |
| 主播用户ID | VARCHAR(64)     | NK | 关注自己的粉丝列表  |

## **9.文件元信息表**

| 字段     | 类型              | 约束 | 备注           |
| :----- | :-------------- | :- | :----------- |
| ID     | BIGINT UNSIGNED | PK |              |
| 文件ID   | VARCHAR(64)     | UK |              |
| 上传用户ID | VARCHAR(64)     | NK |              |
| 存储路径   | VARCHAR(128)    |    | FASTDFS存储ID  |
| 文件大小   | INT UNSIGNED    |    |              |
| 文件mime | VARCHAR(16)     |    | Content-Type |

## **10.视频元信息表**

| 字段     | 类型              | 约束 | 备注                                             |
| :----- | :-------------- | :- | :--------------------------------------------- |
| ID     | BIGINT UNSIGNED | PK |                                                |
| 视频ID   | VARCHAR(64)     | UK |                                                |
| 视频文件ID | VARCHAR(64)     |    | 用于查找视频文件                                       |
| 封面文件ID | VARCHAR(64)     |    | 用于查找封面文件                                       |
| 上传用户ID | VARCHAR(64)     | FK | 用于查找用户视频                                       |
| 审核用户ID | VARCHAR(64)     |    |                                                |
| 视频标题   | VARCHAR(255)    |    |                                                |
| 视频简介   | TEXT            |    |                                                |
| 播放量    | INT UNSIGNED    |    |                                                |
| 视频时长   | INT UNSIGNED    |    |                                                |
| 上传时间   | DATETIME        |    |                                                |
| 视频状态   | TINYINT         | NK | 0=未知/所有状态1=审核中2=审核通过-上架中3=审核拒绝4=已下架5=转码中6=转码失败 |

## **11.用户点赞关联表**

| 字段   | 类型              | 约束 | 备注 |
| :--- | :-------------- | :- | :- |
| ID   | BIGINT UNSIGNED | PK |    |
| 用户ID | VARCHAR(64)     |    |    |
| 视频ID | VARCHAR(64)     | NK |    |

## **12.视频标签关联表**

| 字段   | 类型              | 约束 | 备注       |
| :--- | :-------------- | :- | :------- |
| ID   | BIGINT UNSIGNED | PK |          |
| 视频ID | VARCHAR(64)     | FK | 用于查找视频标签 |
| 标签ID | INT             | NK | 用于查找视频标签 |
| 分类ID | INT             | NK | 用于查找分类视频 |

## **13.弹幕信息表**

| 字段   | 类型              | 约束 | 备注     |
| :--- | :-------------- | :- | :----- |
| ID   | BIGINT UNSIGNED | PK |        |
| 弹幕ID | VARCHAR(64)     | UK |        |
| 视频ID | VARCHAR(64)     | FK | 用于查找视频 |
| 用户ID | VARCHAR(64)     |    | 用于查找用户 |
| 弹幕内容 | VARCHAR(255)    |    |        |
| 弹幕时间 | INT             |    | 相对视频秒数 |

## **14.ES视频信息索引字段**

| 字段   | 类型      | 备注                      |
| :--- | :------ | :---------------------- |
| 视频ID | keyword |                         |
| 视频标题 | text    | analyzer: ikmaxboost: 3 |
| 视频简介 | text    | analyzer: ikmax         |
| 视频状态 | bool    | index: falseboost: 1    |

# ***二、redis缓存淘汰策略***

| 缓存项      | 缓存时间          | 说明                  |
| :------- | :------------ | :------------------ |
| 验证码      | 5 \~ 10 分钟    | 用户注册 / 登录 / 找回密码验证码 |
| 会话       | 120 \~ 180 分钟 | 用户登录会话信息            |
| 授权信息     | 永久            | 角色权限关系，基本不变         |
| 用户信息     | 60 \~ 120 分钟  | 基础资料（昵称、头像等）        |
| 用户统计数据   | 不限制           | 子服务同步管理（粉丝数、点赞数等）   |
| 用户身份角色   | 60 \~ 120 分钟  | 用户身份 + 角色关系         |
| 视频信息     | 60 \~ 120 分钟  | 视频元信息（标题、简介、状态等）    |
| 视频统计数据   | 不限制           | 子服务同步管理（播放量、点赞数等）   |
| 主页视频列表缓存 | 10 \~ 20 分钟   | 首页推荐视频列表            |
| 用户视频列表缓存 | 30 \~ 60 分钟   | 个人主页的视频列表           |
| 分类视频列表缓存 | 10 \~ 20 分钟   | 分类下的视频列表            |
| 标签视频列表缓存 | 30 \~ 60 分钟   | 标签下的视频列表            |
| 状态视频列表缓存 | 不缓存           | 动态查询（审核、转码、上下架状态）   |

## ***三、缓存策略***

1.mysql与redis的缓存双写同步策略
